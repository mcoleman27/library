<!doctype html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.js"></script>

<title>
  Page Title
</title>

<style>
  #column {
    width: 400px;
    height: 800px;
    background-color: darkgray;
  }
  #chart {
    width: 100%;
    height: 400px;
    background-color: lightgrey;
  }
</style>

<div id="column">
  <div id="chart"></div>
</div>



<script>
  let chartWidth  = d3.select("#column").node().clientWidth,
      chartHeight = parseInt(d3.select("#chart").style("height"));

  let div = d3.select("#chart");

  let svg = div
    .append("svg")
    .attrs({"width": div.node().clientWidth, "height": div.node().clientHeight})

  function drawGrid(svg, columns, rows, drawFn){
    // var bBox = svg.getBBox();
    let width = svg.node().getBoundingClientRect().width
    let height = svg.node().getBoundingClientRect().height
    console.log(width+", "+height)

    let cellWidth = width / columns
    let cellHeight = height / rows

    for (var r = 0; r < rows; r++) {
      for (var c = 0; c < columns; c++) {
        let sub = svg
          .append("svg")
          .attr("transform", "translate("+ (cellWidth * c) +","+ (cellHeight * r) +")")
          .attr("width", cellWidth)
          .attr("height", cellHeight)

        drawFn(sub, r, c)
      }
    }
  }
</script>

<script>

  function drawFn(svg, i, j){
    let colour = '#'+(0x1000000+(Math.random())*0xffffff).toString(16).substr(1,6)
  
    let size = svg.node().getBoundingClientRect()
    
    let g = svg.append("g")

    g
      .append("rect")
      .attr("width", size.width)
      .attr("height", size.height)
      .attr("fill", colour)

    let data = [4,7,2,5,1,7,8]

    let y = d3.scaleLinear()
      .domain([0, 8])
      .range([size.height, 0]);

    g
      .selectAll("rect")
      .data(data)  
      .enter()
      .append("rect")
      .attr("y",d => y(d))
      .attr("x", (d,i) => i * 10)
      .attr("width", 10)
      .attr("height", d => size.height - y(d))
      .attr("fill", "black"); 
  }
  
  drawGrid(svg, 3, 3, drawFn);
  
</script>